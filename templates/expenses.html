{% extends "base.html" %}
{% block title %}Expenses{% endblock %}

{% block head %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
document.addEventListener("DOMContentLoaded", function () {
  const expenseTableBody = document.getElementById("expenseTableBody");
  const cardsWrap = document.getElementById("expenseCards");
  const hourlyWageInput = document.getElementById("userHourlyRate");
  const addBtn = document.getElementById("addExpenseBtn");

  function hourlyRate() {
    return parseFloat(hourlyWageInput.value) || 0;
  }

  function calcHours(amount) {
    const rate = hourlyRate();
    return rate > 0 ? (amount / rate) : 0;
  }

  function recalcRow(row) {
    const amountInput = row.querySelector(".expenseAmount");
    const hourlyCostSpan = row.querySelector(".expenseHourly");
    const amount = parseFloat(amountInput.value) || 0;
    hourlyCostSpan.textContent = calcHours(amount).toFixed(2);
  }

  function recalcTotals() {
    let totalAmount = 0;
    let totalHourly = 0;
    const rate = hourlyRate();

    document.querySelectorAll("#expenseTableBody tr").forEach(function (row) {
      const amount = parseFloat(row.querySelector(".expenseAmount").value) || 0;
      totalAmount += amount;
      if (rate > 0) totalHourly += (amount / rate);
    });

    document.getElementById("totalAmount").textContent = totalAmount.toFixed(2);
    document.getElementById("totalHourly").textContent = totalHourly.toFixed(2);
    document.getElementById("expensesTotalInput").value = totalAmount.toFixed(2);
  }

  function syncCardsFromTable() {
    cardsWrap.innerHTML = "";

    document.querySelectorAll("#expenseTableBody tr").forEach((row, idx) => {
      const nameEl = row.querySelector(".expenseName");
      const amountEl = row.querySelector(".expenseAmount");
      const catEl = row.querySelector(".expenseCategory");

      const name = nameEl.value || "";
      const amount = amountEl.value || "";
      const category = catEl.value || "Other";

      const hours = calcHours(parseFloat(amount) || 0).toFixed(2);

      const safeName = name.replace(/&/g, "&amp;")
                           .replace(/</g, "&lt;")
                           .replace(/>/g, "&gt;")
                           .replace(/"/g, "&quot;")
                           .replace(/'/g, "&#039;");

      const card = document.createElement("div");
      card.className = "expense-card";
      card.innerHTML = `
        <div class="expense-card-title">Expense #${idx + 1}</div>

        <div class="expense-card-grid">
          <div class="full">
            <label>Expense Item</label>
            <input type="text" class="cardName" value="${safeName}" required>
          </div>

          <div>
            <label>Amount ({{ currency }})</label>
            <input type="number" step="0.01" class="cardAmount" value="${amount}" required>
          </div>

          <div>
            <label>Category</label>
            <select class="cardCategory" required>
              ${["Rent","Utilities","Savings","Discretionary","Other"].map(c =>
                `<option value="${c}" ${c===category ? "selected" : ""}>${c}</option>`
              ).join("")}
            </select>
          </div>
        </div>

        <div class="expense-meta">
          <span><strong>Hours:</strong> <span class="cardHours">${hours}</span></span>
          <button type="button" class="removeButton">Remove</button>
        </div>
      `;

      const cardName = card.querySelector(".cardName");
      const cardAmount = card.querySelector(".cardAmount");
      const cardCategory = card.querySelector(".cardCategory");
      const cardHours = card.querySelector(".cardHours");

      cardName.addEventListener("input", () => {
        nameEl.value = cardName.value;
      });

      cardAmount.addEventListener("input", () => {
        amountEl.value = cardAmount.value;
        recalcRow(row);
        recalcTotals();
        cardHours.textContent = calcHours(parseFloat(cardAmount.value) || 0).toFixed(2);
      });

      cardCategory.addEventListener("change", () => {
        catEl.value = cardCategory.value;
      });

      card.querySelector(".removeButton").addEventListener("click", () => {
        row.remove();
        recalcTotals();
        syncCardsFromTable();
      });

      cardsWrap.appendChild(card);
    });
  }

  function addRowListeners(row) {
    const amountInput = row.querySelector(".expenseAmount");
    const nameInput = row.querySelector(".expenseName");
    const catSelect = row.querySelector(".expenseCategory");

    [amountInput, nameInput, catSelect].forEach(el => {
      el.addEventListener("input", () => {
        recalcRow(row);
        recalcTotals();
        syncCardsFromTable();
      });
      el.addEventListener("change", () => {
        recalcRow(row);
        recalcTotals();
        syncCardsFromTable();
      });
    });

    row.querySelector(".removeRow").addEventListener("click", function () {
      row.remove();
      recalcTotals();
      syncCardsFromTable();
    });
  }

  function addExpenseRow(name = "", amount = "", category = "Other") {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td><input type="text" name="expense_name[]" class="expenseName" value="${name}" required></td>
      <td><input type="number" step="0.01" name="expense_amount[]" class="expenseAmount" value="${amount}" required></td>
      <td>
        <select name="expense_category[]" class="expenseCategory" required>
          <option value="Rent" ${category === "Rent" ? "selected" : ""}>Rent</option>
          <option value="Utilities" ${category === "Utilities" ? "selected" : ""}>Utilities</option>
          <option value="Savings" ${category === "Savings" ? "selected" : ""}>Savings</option>
          <option value="Discretionary" ${category === "Discretionary" ? "selected" : ""}>Discretionary</option>
          <option value="Other" ${category === "Other" ? "selected" : ""}>Other</option>
        </select>
      </td>
      <td><span class="expenseHourly">0.00</span></td>
      <td><button type="button" class="removeRow">Remove</button></td>
    `;

    expenseTableBody.appendChild(row);
    addRowListeners(row);
    recalcRow(row);
    recalcTotals();
    syncCardsFromTable();
  }

  // Add button
  addBtn.addEventListener("click", () => addExpenseRow());

  // Hourly rate changes
  hourlyWageInput.addEventListener("input", () => {
    document.querySelectorAll("#expenseTableBody tr").forEach(recalcRow);
    recalcTotals();
    syncCardsFromTable();
  });

  // Prefill from saved_expenses
  const existing = [
    {% for e in saved_expenses %}
      { name: {{ e.name|tojson }}, amount: {{ e.amount|tojson }}, category: {{ e.category|tojson }} }{% if not loop.last %},{% endif %}
    {% endfor %}
  ];

  if (existing.length) {
    existing.forEach(e => addExpenseRow(e.name, e.amount, e.category));
  } else {
    addExpenseRow();
  }
});
</script>

{% endblock %}

{% block content %}
<div class="form-container">
  <h1>Expenses</h1>
  <p>Add, remove, or modify expense items below. The hourly expense is computed by dividing the cost by your hourly rate.</p>

  <form action="{{ url_for('expenses') }}" method="post">
    <div>
      <label for="userHourlyRate">Your Hourly Rate ({{ currency }}):</label>
      <input type="number" step="0.01" id="userHourlyRate" name="user_hourly_rate"
             value="{{ session.get('hourlyRate', '') }}" required>
      <small>This can be auto-filled from Personal Information or manually adjusted.</small>
    </div>

    <!-- Desktop table -->
    <table class="expense-table">
      <thead>
        <tr>
          <th>Expense Item</th>
          <th>Expense ({{ currency }})</th>
          <th>Category</th>
          <th>Expense (Hours)</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody id="expenseTableBody">
        <!-- Rows injected by JS -->
      </tbody>
      <tfoot>
        <tr>
          <td><strong>Total</strong></td>
          <td><strong id="totalAmount">0.00</strong></td>
          <td></td>
          <td><strong id="totalHourly">0.00</strong></td>
          <td></td>
        </tr>
      </tfoot>
    </table>

    <!-- Mobile cards -->
    <div id="expenseCards" class="expense-cards"></div>

    <input type="hidden" name="expensesTotal" id="expensesTotalInput" value="0.00">

    <button type="button" id="addExpenseBtn">Add Expense</button>

    <div>
      <button type="submit">Save Expenses</button>
    </div>
  </form>
</div>

{% if category_totals %}
  <div class="chart-container">
    <canvas id="categoryChart"></canvas>
  </div>
  <script>
    const ctx = document.getElementById("categoryChart").getContext("2d");
    new Chart(ctx, {
      type: "pie",
      data: {
        labels: [{% for row in category_totals %}"{{ row.category }}"{% if not loop.last %},{% endif %}{% endfor %}],
        datasets: [{
          data: [{% for row in category_totals %}{{ row.total }}{% if not loop.last %},{% endif %}{% endfor %}],
          backgroundColor: ["#ff6384", "#36a2eb", "#ffcd56", "#4bc0c0"]
        }]
      },
      options: {
        plugins: {
          title: { display: true, text: "Expenses by Category" },
          legend: { position: "bottom" }
        }
      }
    });
  </script>
{% endif %}
{% endblock %}
