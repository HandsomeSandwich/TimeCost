{% extends "base.html" %}
{% block title %}Staples - Time Cost{% endblock %}

{% block head %}
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const stapleTableBody = document.getElementById("stapleTableBody");
      const hourlyRateInput = document.getElementById("stapleHourlyRate");
      const addBtn = document.getElementById("addStapleBtn");

      function escapeAttr(s) {
        return String(s ?? "")
          .replace(/&/g, "&amp;")
          .replace(/"/g, "&quot;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/'/g, "&#039;");
      }

      function hourlyRate() {
        return parseFloat(hourlyRateInput.value) || 0;
      }

      function calcHours(cost) {
        const rate = hourlyRate();
        return rate > 0 ? (cost / rate) : 0;
      }

      function recalcRow(row) {
        const costInput = row.querySelector(".stapleCost");
        const timeSpan = row.querySelector(".stapleTime");
        const cost = parseFloat(costInput.value) || 0;
        timeSpan.textContent = calcHours(cost).toFixed(2);
      }

      function recalcTotals() {
        let totalCost = 0;
        let totalTime = 0;

        document.querySelectorAll("#stapleTableBody tr").forEach((row) => {
          const cost = parseFloat(row.querySelector(".stapleCost").value) || 0;
          totalCost += cost;
          totalTime += calcHours(cost);
        });

        document.getElementById("totalCost").textContent = totalCost.toFixed(2);
        document.getElementById("totalTime").textContent = totalTime.toFixed(2);
      }

      function addRowListeners(row) {
        const nameInput = row.querySelector(".stapleName");
        const costInput = row.querySelector(".stapleCost");

        function onEdit() {
          recalcRow(row);
          recalcTotals();
        }

        nameInput.addEventListener("input", onEdit);
        costInput.addEventListener("input", onEdit);

        row.querySelector(".removeStaple").addEventListener("click", () => {
          row.remove();
          recalcTotals();
        });
      }

      function addStapleRow(itemName = "", costValue = "") {
        const row = document.createElement("tr");

        const safeName = escapeAttr(itemName);
        const safeCost = escapeAttr(costValue);

        row.innerHTML = `
          <td><input type="text" class="stapleName" value="${safeName}" placeholder="e.g. Milk" required></td>
          <td><input type="number" step="0.01" class="stapleCost" value="${safeCost}" placeholder="0.00" required></td>
          <td><span class="stapleTime">0.00</span></td>
          <td><button type="button" class="removeStaple removeButton">Remove</button></td>
        `;

        stapleTableBody.appendChild(row);
        addRowListeners(row);
        recalcRow(row);
        recalcTotals();
      }

      hourlyRateInput.addEventListener("input", () => {
        document.querySelectorAll("#stapleTableBody tr").forEach(recalcRow);
        recalcTotals();
      });

      addBtn.addEventListener("click", () => addStapleRow());

      // Start with one row
      addStapleRow();
    });
  </script>
{% endblock %}

{% block content %}
<div class="form-container">
  <h1>Staples - Time Cost</h1>
  <p>
    Add staple items and their costs. Using your hourly rate, this page estimates how many work hours
    it takes to earn each item.
  </p>

  <div class="field">
    <label for="stapleHourlyRate">Your Hourly Rate ({{ currency }}):</label>
    <input type="number" step="0.01" id="stapleHourlyRate"
           value="{{ hourlyRate or '' }}"
           placeholder="Enter your hourly rate" required>
    <div class="hint">Tip: This can match your Personal hourly rate for consistency.</div>
  </div>

  <div class="table-wrap">
    <table class="expense-table table-wide">
      <thead>
        <tr>
          <th>Item</th>
          <th>Cost ({{ currency }})</th>
          <th>Time to Earn (hrs)</th>
          <th>Action</th>
        </tr>
      </thead>

      <tbody id="stapleTableBody"></tbody>

      <tfoot>
        <tr>
          <td><strong>Total</strong></td>
          <td><strong id="totalCost">0.00</strong></td>
          <td><strong id="totalTime">0.00</strong></td>
          <td></td>
