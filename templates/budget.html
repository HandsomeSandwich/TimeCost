{% extends "base.html" %}
{% block title %}Budget Calculator{% endblock %}

{% macro goal_progress(goal) -%}
  {% set raw = (goal.current / goal.target * 100) if goal.target > 0 else 0 %}
  {{ 100 if raw > 100 else (0 if raw < 0 else raw) }}
{%- endmacro %}

{% block head %}
  {{ super() }}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="form-container">
  <h1>Budget Calculator</h1>

  <form method="POST" action="{{ url_for('budget') }}">
    <div class="field">
      <label for="income">Monthly Income ({{ currency }}):</label>
      <input type="number" step="0.01" id="income" name="income" value="{{ income or '' }}" required>
    </div>

    <div class="field">
      <label for="expenses">Monthly Expenses ({{ currency }}):</label>
      <input type="number" step="0.01" id="expenses" name="expenses" value="{{ expenses or '' }}" readonly>
      <div class="hint">This total is pulled from your Expenses page.</div>
    </div>

    <div class="field">
      <label for="weeklyHours">Weekly Hours:</label>
      <input type="number" step="0.1" id="weeklyHours" name="weeklyHours" value="{{ weekly_hours or '' }}" required>
    </div>

    <div class="field">
      <label for="savingsGoal">Long Term Savings Goal ({{ currency }}):</label>
      <input type="number" step="0.01" id="savingsGoal" name="savingsGoal" value="{{ savings_goal or '' }}">
    </div>

    <div class="field">
      <label for="currentSavings">Amount Already Saved ({{ currency }}):</label>
      <input type="number" step="0.01" id="currentSavings" name="currentSavings" value="{{ current_savings or '' }}">
    </div>

    <button type="submit">Calculate</button>
  </form>

  {% if hourly_value is not none %}
    <div class="result-card">
      <h2>Budget Results</h2>
      <p><strong>Monthly Discretionary Income:</strong> {{ currency }}{{ discretionary_income|round(2) }}</p>
      <p><strong>Estimated Hourly Value (of discretionary income):</strong> {{ currency }}{{ hourly_value|round(2) }}/hr</p>
    </div>

    <div class="chart-container">
      <canvas id="budgetChart"></canvas>
    </div>

    <script>
      const ctx = document.getElementById("budgetChart").getContext("2d");

      // Theme-aware chart colors from CSS vars
      const styles = getComputedStyle(document.documentElement);
      const primary = styles.getPropertyValue("--primary").trim() || "#A3B18A";
      const accent = styles.getPropertyValue("--accent").trim() || "#E07A5F";
      const secondary = styles.getPropertyValue("--secondary-accent").trim() || "#FFD37F";
      const textDark = styles.getPropertyValue("--text-dark").trim() || "#2F3E46";

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Income', 'Expenses', 'Discretionary'],
          datasets: [{
            label: 'Monthly Budget',
            data: {{ [income|default(0), expenses|default(0), discretionary_income|default(0)] | tojson }},
            backgroundColor: [primary, accent, secondary],
            borderWidth: 1,
            borderColor: textDark
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            title: { display: true, text: 'Monthly Budget Overview' },
            legend: { display: false }
          },
          scales: { y: { beginAtZero: true } }
        }
      });
    </script>
  {% endif %}

  <div class="goals-section">
    <h2>Long Term Savings Goals</h2>

    {% if goals %}
      <div class="table-wrap">
        <table class="goal-table">
          <thead>
            <tr>
              <th>Goal Name</th>
              <th>Target ({{ currency }})</th>
              <th>Saved ({{ currency }})</th>
              <th>Progress</th>
            </tr>
          </thead>

          <tbody>
            {% for goal in goals %}
              {% set progress = goal_progress(goal)|float %}
              <tr>
                <td>{{ goal.name }}</td>
                <td>{{ currency }}{{ goal.target|round(2) }}</td>
                <td>{{ currency }}{{ goal.current|round(2) }}</td>
                <td>
                  <div class="progress-container">
                    <div class="progress-bar" style="width: {{ progress }}%;">
                      {{ progress|round(1) }}%
                    </div>
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p>No goals added yet.</p>
    {% endif %}
  </div>
</div>
{% endblock %}
