{% extends "base.html" %}

{% block title %}TimeCost Calculator{% endblock %}

{% block content %}

{% set perspective = session.get("perspective", "river") %}

{% set copy = {
  "river": {
  "intro": "Enter your item’s details and see how time begins to take shape.",
  "hours_line": "This settles at about",
  "thats": "Which is",
  "invalid": "Something here hasn’t settled yet.",
  "live_title": "Time, Measured",

  "err_cost": "The cost hasn’t come into focus.",
  "err_wage": "Your wage needs a little more shape.",
  "err_convert": "These numbers don’t resolve into an hourly rhythm."
},

  "leslie": {
  "intro": "Okay, amazing human. Let’s calculate how much time this costs so you can make an informed, powerful life decision.",
  "hours_line": "This comes to about",
  "thats": "Which equals",
  "invalid": "Totally fine! One of the inputs just needs a quick fix.",
  "live_title": "Live Result (Civic Pride Edition)",

  "err_cost": "That cost needs adjusting — and I believe in you.",
  "err_wage": "Your wage amount needs a tweak. This is normal. We are calm.",
  "err_convert": "These numbers need a moment to cooperate. They will."
},

  "eddie": {
  "intro": "Right. Let’s see what this little indulgence thinks your life is worth.",
  "hours_line": "This costs you",
  "thats": "Which is",
  "invalid": "Darling. No. These numbers are a shambles.",

  "live_title": "Live Result (I Tried to Warn You)",

  "err_cost": "That cost is fantasy. Enter reality.",
  "err_wage": "That wage won’t work. Try again, properly.",
  "err_convert": "This conversion is having a nervous breakdown. Adjust accordingly."
}

} %}
{% set c = copy.get(perspective, copy["river"]) %}


<div class="form-container">
  <h1>TimeCost Calculator</h1>
  <p>{{ c.intro }}</p>


  <form action="{{ url_for('calculator') }}" method="post" class="calc-form" id="calcForm">
    <div class="field">
      <label for="itemName">Item Name (optional):</label>
      <input type="text" id="itemName" name="itemName" value="{{ item_name or '' }}">
    </div>

    <div class="field">
      <label for="itemCost">Item Cost ({{ currency }}):</label>
      <input
        type="number"
        step="0.01"
        id="itemCost"
        name="itemCost"
        value="{{ item_cost or '' }}"
        required
      >
    </div>

    <fieldset class="radio-group field">
      <legend>Salary Type:</legend>
      <label><input type="radio" name="wageType" value="hourly" {% if pre_wage_type == "hourly" %}checked{% endif %}> Hourly</label>
      <label><input type="radio" name="wageType" value="monthly" {% if pre_wage_type == "monthly" %}checked{% endif %}> Monthly</label>
      <label><input type="radio" name="wageType" value="annual" {% if pre_wage_type == "annual" %}checked{% endif %}> Annual</label>
    </fieldset>

    <div class="field">
      <label for="wageAmount">Your Wage Amount ({{ currency }}):</label>
      <input
        type="number"
        step="0.01"
        id="wageAmount"
        name="wageAmount"
        value="{{ pre_wage_amount or '' }}"
      >
      <small id="rateHint"></small>
    </div>

    <button type="submit">Calculate Time Cost</button>
  </form>

  <!-- LIVE result card (always in DOM, updated by JS) -->
  <div class="result-card" id="liveResult" role="status" aria-live="polite" style="display:none;">
    <h2 id="resultTitle">Result</h2>

    <p id="resultHoursLine"></p>
    <p id="resultHumanLine"></p>
    <p class="error-text" id="resultError" style="display:none;"></p>
  </div>

  <!-- Server result (still works after submit) -->
  {% if result == "Invalid input" %}
    <div class="result-card" role="status">
      <h2>Result</h2>
      <p class="error-text">{{ c.invalid }}</p>
    </div>

  {% elif result is not none %}
    <div class="result-card" role="status">
      <h2>Result{% if item_name %} for “{{ item_name }}”{% endif %}</h2>

      <p>
        {{ c.hours_line }} <strong>{{ result|round(2) }}</strong> hours of work.
      </p>


      {% if time_cost and time_cost.ok %}
        <p>
          {{ c.thats }} <strong>{{ time_cost.human }}</strong>
          {% if workday_text %}({{ workday_text }}){% endif %}.
        </p>

      {% elif time_cost and not time_cost.ok %}
        <p class="error-text">{{ c.invalid }}</p>
      {% endif %}
    </div>
  {% endif %}
</div>

<script>
(function () {
  const itemCostEl = document.getElementById("itemCost");
  const wageAmountEl = document.getElementById("wageAmount");
  const wageTypeEls = () => document.querySelectorAll('input[name="wageType"]');

  const liveResult = document.getElementById("liveResult");
  const resultTitle = document.getElementById("resultTitle");
  const resultHoursLine = document.getElementById("resultHoursLine");
  const resultHumanLine = document.getElementById("resultHumanLine");
  const resultError = document.getElementById("resultError");
  const rateHint = document.getElementById("rateHint");

  const COPY = {
    liveTitle: {{ c.live_title|tojson }},
    hoursLine: {{ c.hours_line|tojson }},
    thats: {{ c.thats|tojson }},
    errCost: {{ c.err_cost|tojson }},
    errWage: {{ c.err_wage|tojson }},
    errConvert: {{ c.err_convert|tojson }}
  };

  function getWageType() {
    const checked = document.querySelector('input[name="wageType"]:checked');
    return checked ? checked.value : "hourly";
  }

  function hourlyFromWage(amount, type) {
    if (!Number.isFinite(amount) || amount <= 0) return 0;
    if (type === "annual") return amount / 2080;     // 52w * 40h
    if (type === "monthly") return amount / 173.33;  // 40h * 52 / 12
    return amount; // hourly
  }

  function toHumanHours(hours) {
    if (!Number.isFinite(hours) || hours < 0) return "";
    const totalMinutes = Math.round(hours * 60);
    const h = Math.floor(totalMinutes / 60);
    const m = totalMinutes % 60;

    if (h === 0 && m === 0) return "0m";
    if (h === 0) return `${m}m`;
    if (m === 0) return `${h}h`;
    return `${h}h ${m}m`;
  }

  function workdayEquivalent(hours, hoursPerDay = 8) {
    if (!Number.isFinite(hours) || hours <= 0) return "";
    const days = hours / hoursPerDay;

    if (days < 0.25) return "less than a quarter workday";
    if (days < 1) return `about ${Math.round(days * 10) / 10} workday`;
    if (days < 2) return "about 1 workday";
    return `about ${Math.round(days * 10) / 10} workdays`;
  }

  function showError(msg) {
    liveResult.style.display = "block";
    resultTitle.textContent = COPY.liveTitle;

    resultError.style.display = "block";
    resultError.textContent = msg;

    resultHoursLine.textContent = "";
    resultHumanLine.textContent = "";
  }

  function clearError() {
    resultError.style.display = "none";
    resultError.textContent = "";
  }

  function updateHint(type) {
    if (!rateHint) return;
    if (type === "annual") rateHint.textContent = "Converted using 2080 working hours/year.";
    else if (type === "monthly") rateHint.textContent = "Converted using ~173.33 working hours/month.";
    else rateHint.textContent = "";
  }

  function recalc() {
    const wageType = getWageType();
    updateHint(wageType);

    const costRaw = (itemCostEl?.value ?? "").trim();
    const wageRaw = (wageAmountEl?.value ?? "").trim();

    // Hide until user starts typing something meaningful
    const hasAnything = costRaw !== "" || wageRaw !== "";
    if (!hasAnything) {
      liveResult.style.display = "none";
      return;
    }

    const cost = parseFloat(costRaw);
    const wageAmount = parseFloat(wageRaw);
    const hourly = hourlyFromWage(wageAmount, wageType);

    if (!Number.isFinite(cost) || cost < 0) return showError(COPY.errCost);
    if (!Number.isFinite(wageAmount) || wageAmount <= 0) return showError(COPY.errWage);
    if (!Number.isFinite(hourly) || hourly <= 0) return showError(COPY.errConvert);

    clearError();

    const hours = cost / hourly;
    const human = toHumanHours(hours);
    const workday = workdayEquivalent(hours);

    liveResult.style.display = "block";
    resultTitle.textContent = COPY.liveTitle;

    resultHoursLine.innerHTML =
      `${COPY.hoursLine} <strong>${hours.toFixed(2)}</strong> hours of work.`;

    resultHumanLine.innerHTML =
      `${COPY.thats} <strong>${human}</strong>${workday ? ` (${workday})` : ""}.`;
  }

  itemCostEl?.addEventListener("input", recalc);
  wageAmountEl?.addEventListener("input", recalc);
  wageTypeEls().forEach(r => r.addEventListener("change", recalc));

  recalc();
})();
</script>
