{% extends "base.html" %}

{% block title %}TimeCost Calculator{% endblock %}

{% block content %}

{% set perspective = session.get("perspective", "river") %}

{% set copy = {
  "river": {
    "intro": "Enter your item’s details to see how much work time it costs.",
    "hours_line": "This item costs approximately",
    "thats": "That’s",
    "invalid": "Invalid input. Please check your values.",
    "live_title": "Live Result"
  },
  "leslie": {
    "intro": "Okay team, let’s do the math and make your money serve your dreams.",
    "hours_line": "This item will require roughly",
    "thats": "That’s",
    "invalid": "Nope. Something’s off. Let’s fix the numbers and try again.",
    "live_title": "Live Result (Optimism Mode)"
  },
  "eddie": {
    "intro": "Right, darling. Let’s see how much of your actual life this little purchase wants to eat.",
    "hours_line": "This item costs you about",
    "thats": "That’s",
    "invalid": "Darling. Those numbers are a mess. Try again with something that exists in this universe.",
    "live_title": "Live Result (Drama)"
  }
} %}
{% set c = copy.get(perspective, copy["river"]) %}


<div class="form-container">
  <h1>TimeCost Calculator</h1>
  <p>{{ c.intro }}</p>


  <form action="{{ url_for('calculator') }}" method="post" class="calc-form" id="calcForm">
    <div class="field">
      <label for="itemName">Item Name (optional):</label>
      <input type="text" id="itemName" name="itemName" value="{{ item_name or '' }}">
    </div>

    <div class="field">
      <label for="itemCost">Item Cost ({{ currency }}):</label>
      <input
        type="number"
        step="0.01"
        id="itemCost"
        name="itemCost"
        value="{{ item_cost or '' }}"
        required
      >
    </div>

    <fieldset class="radio-group field">
      <legend>Salary Type:</legend>
      <label><input type="radio" name="wageType" value="hourly" {% if pre_wage_type == "hourly" %}checked{% endif %}> Hourly</label>
      <label><input type="radio" name="wageType" value="monthly" {% if pre_wage_type == "monthly" %}checked{% endif %}> Monthly</label>
      <label><input type="radio" name="wageType" value="annual" {% if pre_wage_type == "annual" %}checked{% endif %}> Annual</label>
    </fieldset>

    <div class="field">
      <label for="wageAmount">Your Wage Amount ({{ currency }}):</label>
      <input
        type="number"
        step="0.01"
        id="wageAmount"
        name="wageAmount"
        value="{{ pre_wage_amount or '' }}"
        required
      >
      <small id="rateHint"></small>
    </div>

    <button type="submit">Calculate Time Cost</button>
  </form>

  <!-- LIVE result card (always in DOM, updated by JS) -->
  <div class="result-card" id="liveResult" role="status" aria-live="polite" style="display:none;">
    <h2 id="resultTitle">Result</h2>

    <p id="resultHoursLine"></p>
    <p id="resultHumanLine"></p>
    <p class="error-text" id="resultError" style="display:none;"></p>
  </div>

  <!-- Server result (still works after submit) -->
  {% if result == "Invalid input" %}
    <div class="result-card" role="status">
      <h2>Result</h2>
      <p class="error-text">Invalid input. Please check your values.</p>
    </div>

  {% elif result is not none %}
    <div class="result-card" role="status">
      <h2>Result{% if item_name %} for “{{ item_name }}”{% endif %}</h2>

      <p>
        {{ c.hours_line }} <strong>{{ result|round(2) }}</strong> hours of work.
      </p>


      {% if time_cost and time_cost.ok %}
        <p>
          {{ c.thats }} <strong>{{ time_cost.human }}</strong>
          {% if workday_text %}({{ workday_text }}){% endif %}.
        </p>

      {% elif time_cost and not time_cost.ok %}
        <p class="error-text">{{ c.invalid }}</p>
      {% endif %}
    </div>
  {% endif %}
</div>

<script>
(function () {
  const itemCostEl = document.getElementById("itemCost");
  const wageAmountEl = document.getElementById("wageAmount");
  const wageTypeEls = () => document.querySelectorAll('input[name="wageType"]');

  const liveResult = document.getElementById("liveResult");
  const resultTitle = document.getElementById("resultTitle");
  const resultHoursLine = document.getElementById("resultHoursLine");
  const resultHumanLine = document.getElementById("resultHumanLine");
  const resultError = document.getElementById("resultError");
  const rateHint = document.getElementById("rateHint");

  function getWageType() {
    const checked = document.querySelector('input[name="wageType"]:checked');
    return checked ? checked.value : "hourly";
  }

  function hourlyFromWage(amount, type) {
    if (!isFinite(amount) || amount <= 0) return 0;
    if (type === "annual") return amount / 2080;     // 52w * 40h
    if (type === "monthly") return amount / 173.33;  // 40h * 52 / 12
    return amount; // hourly
  }

  function toHumanHours(hours) {
    if (!isFinite(hours) || hours < 0) return "";
    const totalMinutes = Math.round(hours * 60);
    const h = Math.floor(totalMinutes / 60);
    const m = totalMinutes % 60;

    if (h === 0 && m === 0) return "0m";
    if (h === 0) return `${m}m`;
    if (m === 0) return `${h}h`;
    return `${h}h ${m}m`;
  }

  function workdayEquivalent(hours, hoursPerDay = 8) {
    if (!isFinite(hours) || hours <= 0) return "";
    const days = hours / hoursPerDay;

    if (days < 0.25) return "less than a quarter workday";
    if (days < 1) return `about ${Math.round(days * 10) / 10} workday`;
    if (days < 2) return "about 1 workday";
    return `about ${Math.round(days * 10) / 10} workdays`;
  }

  function showError(msg) {
    liveResult.style.display = "block";
    resultError.style.display = "block";
    resultError.textContent = msg;

    resultHoursLine.textContent = "";
    resultHumanLine.textContent = "";
  }

  function clearError() {
    resultError.style.display = "none";
    resultError.textContent = "";
  }

  function updateHint(type) {
    if (type === "annual") rateHint.textContent = "Converted using 2080 working hours/year.";
    else if (type === "monthly") rateHint.textContent = "Converted using ~173.33 working hours/month.";
    else rateHint.textContent = "";
  }

    function recalc() {
    const wageType = getWageType();
    updateHint(wageType);

    const cost = parseFloat(itemCostEl.value);
    const wageAmount = parseFloat(wageAmountEl.value);
    const hourly = hourlyFromWage(wageAmount, wageType);

    const hasAnything = (itemCostEl.value.trim() !== "" || wageAmountEl.value.trim() !== "");
    if (!hasAnything) {
      liveResult.style.display = "none";
      return;
    }

    if (!isFinite(cost) || cost < 0) return showError("Enter a valid item cost.");
    if (!isFinite(wageAmount) || wageAmount <= 0) return showError("Enter a valid wage amount.");
    if (!isFinite(hourly) || hourly <= 0) return showError("Wage conversion resulted in an invalid hourly rate.");

    clearError();

    const hours = cost / hourly;
    const human = toHumanHours(hours);
    const workday = workdayEquivalent(hours);

    liveResult.style.display = "block";
    resultTitle.textContent = {{ c.live_title|tojson }};
    resultHoursLine.innerHTML =
      `${{ c.hours_line|tojson }} <strong>${hours.toFixed(2)}</strong> hours of work.`;
    resultHumanLine.innerHTML =
      `${{ c.thats|tojson }} <strong>${human}</strong>${workday ? ` (${workday})` : ""}.`;
  }

  // Events
  itemCostEl.addEventListener("input", recalc);
  wageAmountEl.addEventListener("input", recalc);
  wageTypeEls().forEach(r => r.addEventListener("change", recalc));

  recalc();