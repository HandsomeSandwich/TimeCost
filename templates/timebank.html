{% extends "base.html" %}
{% block title %}Time Bank{% endblock %}

{% block head %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="form-container">
  <h1>Time Bank</h1>
  <p>
    Enter your Monthly Income, Expense Total, and Hours Worked per Month.
    Values will be pre-filled if available.
  </p>

  <form method="POST" action="{{ url_for('timebank') }}">
    <div class="field">
      <label for="income">Monthly Income ({{ currency }}):</label>
      <input type="number" step="0.01" id="income" name="income" value="{{ income or '' }}" required>
    </div>

    <div class="field">
      <label for="expenses">Expenses Total ({{ currency }}):</label>
      <input type="number" step="0.01" id="expenses" name="expenses" value="{{ expenses or '' }}" required>
      <div class="hint">Tip: Use your Expenses page total for consistency.</div>
    </div>

    <div class="field">
      <label for="hoursWorked">Hours Worked per Month:</label>
      <input type="number" step="0.1" id="hoursWorked" name="hoursWorked" value="{{ hoursWorked or '' }}" required>
    </div>

    <button type="submit">Calculate Time Bank</button>
  </form>

  {% set income_value = (income|default(0))|float %}
  {% set expenses_value = (expenses|default(0))|float %}
  {% set hours_value = (hoursWorked|default(0))|float %}
  {% set savings_value_num = (savings_value|default(0))|float %}

  {% if income_value > 0 and hours_value > 0 %}
    {% set hourly_wage = income_value / hours_value %}
    {% set savings_hours = (savings_value_num / hourly_wage) if hourly_wage > 0 else 0 %}
    {% set expense_hours = ((expenses_value - savings_value_num) / hourly_wage) if hourly_wage > 0 else 0 %}
    {% set discretionary_hours = hours_value - expense_hours - savings_hours %}

    {# Clamp at 0 to avoid negatives #}
    {% if expense_hours < 0 %}{% set expense_hours = 0 %}{% endif %}
    {% if savings_hours < 0 %}{% set savings_hours = 0 %}{% endif %}
    {% if discretionary_hours < 0 %}{% set discretionary_hours = 0 %}{% endif %}

    <div class="result-card">
      <h2>Results</h2>
      <p><strong>Hourly Wage:</strong> {{ currency }}{{ hourly_wage|round(2) }}/hr</p>
      <p><strong>Savings ({{ currency }}):</strong> {{ currency }}{{ savings_value_num|round(2) }}</p>
      <p><strong>Savings Hours:</strong> {{ savings_hours|round(2) }} hours</p>
      <p><strong>Expense Hours Required:</strong> {{ expense_hours|round(2) }} hours</p>
      <p><strong>Discretionary Hours Left:</strong> {{ discretionary_hours|round(2) }} hours</p>
    </div>

    <div class="chart-container">
      <canvas id="timeBankChart"></canvas>
    </div>

    <script>
      const ctx = document.getElementById('timeBankChart').getContext('2d');

      // Theme-aware chart colors from CSS vars
      const styles = getComputedStyle(document.documentElement);
      const primary = styles.getPropertyValue("--primary").trim() || "#A3B18A";
      const accent = styles.getPropertyValue("--accent").trim() || "#E07A5F";
      const secondary = styles.getPropertyValue("--secondary-accent").trim() || "#FFD37F";
      const textDark = styles.getPropertyValue("--text-dark").trim() || "#2F3E46";

      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Expenses', 'Savings', 'Discretionary'],
          datasets: [{
            data: {{ [expense_hours|round(2), savings_hours|round(2), discretionary_hours|round(2)] | tojson }},
            backgroundColor: [accent, primary, secondary],
            borderWidth: 1,
            borderColor: textDark
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' },
            title: {
              display: true,
              text: 'Time Bank Breakdown (Total Hours: {{ hours_value|round(2) }} hrs)'
            }
          }
        }
      });
    </script>
  {% endif %}
</div>
{% endblock %}
