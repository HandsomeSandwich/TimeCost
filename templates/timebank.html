
{% set savings_value = savings_value|default(0)|float %}

{% extends "base.html" %}
{% block title %}Time Bank{% endblock %}

{% block head %}
  <style>
    .form-container {
      max-width: 800px;
      margin: 0 auto;
      text-align: left;
    }
    .form-container form div {
      margin-bottom: 15px;
    }
    .form-container form label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
    }
    .form-container form input {
      width: 100%;
      padding: 10px;
      font-size: 1rem;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .form-container form button {
      padding: 10px 20px;
      font-size: 1rem;
      border: none;
      border-radius: 4px;
      background-color: #333;
      color: #fff;
      cursor: pointer;
    }
    .form-container form button:hover {
      background-color: #555;
    }
    .chart-container {
      position: relative;
      margin: 40px auto;
      height: 400px;
      width: 400px;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="form-container">
  <h1>Time Bank</h1>
  <p>Enter your Monthly Income, Expense Total, and Hours Worked per Month.
     Values will be pre-filled if available from your Personal Information page.
  </p>

  <form method="POST">
    <div>
      <label for="income">Monthly Income ({{ currency }}):</label>
      <input type="number" step="0.01" id="income" name="income" value="{{ income }}" required>
    </div>
    <div>
      <label for="expenses">Expenses Total ({{ currency }}):</label>
      <input type="number" step="0.01" id="expenses" name="expenses" value="{{ expenses }}" required>
    </div>
    <div>
      <label for="hoursWorked">Hours Worked per Month:</label>
      <input type="number" step="0.1" id="hoursWorked" name="hoursWorked" value="{{ hoursWorked }}" required>
    </div>
    <button type="submit">Calculate Time Bank</button>
  </form>

  {% if income and expenses and hoursWorked %}
  {% set income_value = income|float %}
  {% set expenses_value = expenses|float %}
  {% set hours_value = hoursWorked|float %}
  {% set savings_value = 0 %}
  {% for row in category_totals %}
    {% if row.category == 'Savings' %}
      {% set savings_value = row.total %}
    {% endif %}
  {% endfor %}

  {% if income_value > 0 and hours_value > 0 %}
    {% set hourly_wage = income_value / hours_value %}
    {% set savings_hours = savings_value / hourly_wage %}
    {% set expense_hours = (expenses_value - savings_value) / hourly_wage %}
    {% set discretionary_hours = hours_value - expense_hours - savings_hours %}
  {% else %}
    {% set hourly_wage = 0 %}
    {% set savings_hours = 0 %}
    {% set expense_hours = 0 %}
    {% set discretionary_hours = 0 %}
  {% endif %}


    <h2>Results</h2>
    <p><strong>Hourly Wage:</strong> {{ hourly_wage|round(2) }} {{ currency }}/hr</p>
    <p><strong>Savings ({{ currency }}):</strong> {{ savings_value|round(2) }}</p>
    <p><strong>Savings Hours:</strong> {{ savings_hours|round(2) }} hours</p>
    <p><strong>Expense Hours Required:</strong> {{ expense_hours|round(2) }} hours</p>
    <p><strong>Discretionary Hours Left:</strong> {{ discretionary_hours|round(2) }} hours</p>

    <div class="chart-container">
      <canvas id="timeBankChart"></canvas>
    </div>
    <script>
      const ctx = document.getElementById('timeBankChart').getContext('2d');
      new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['Expenses', 'Savings', 'Discretionary'],
          datasets: [{
            data: [{{ expense_hours|round(2) }}, {{ savings_hours|round(2) }}, {{ discretionary_hours|round(2) }}],
            backgroundColor: [
                'rgba(255, 99, 132, 0.7)',    // Expense Hours
                'rgba(255, 206, 86, 0.7)',    // Savings
                'rgba(75, 192, 192, 0.7)'     // Discretionary Hours
            ],

            borderColor: [
                'rgba(255, 99, 132, 1)',
                'rgba(255, 206, 86, 1)',
                'rgba(54, 162, 235, 1)'
            ],
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' },
            title: {
              display: true,
              text: 'Time Bank Breakdown (Total Hours: {{ hours_value }} hrs)'
            }
          }
        }
      });
    </script>
  {% endif %}
</div>
{% endblock %}
